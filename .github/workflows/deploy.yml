name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'  # 推荐使用稳定的 LTS 版本
    
    - name: Install dependencies
      run: |
        cd vue
        npm ci  # 使用 ci 代替 install，更快更稳定
    
    - name: Build project
      run: |
        cd vue
        npm run build
    
    - name: Prepare deployment
      run: |
        # 创建临时目录用于部署
        mkdir -p deploy_temp
        
        # 复制构建结果
        cp -r vue/dist/* deploy_temp/
        
        # 添加 .nojekyll 文件
        touch deploy_temp/.nojekyll
        
        # 如果 Vue 路由使用 history 模式，添加 404.html
        cp deploy_temp/index.html deploy_temp/404.html 2>/dev/null || true
    
    - name: Deploy to GitHub Pages
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "wu_yi_@outlook.com"
        
        # 切换到 gh-pages 分支或创建新分支
        if git show-ref --verify --quiet refs/heads/gh-pages; then
          git checkout gh-pages
          # 清理旧文件，但保留 .git 目录
          find . -maxdepth 1 ! -name '.git' ! -name '.' -exec rm -rf {} +
        else
          git checkout --orphan gh-pages
          git rm -rf .
        fi
        
        # 移动新文件到根目录
        mv deploy_temp/* .
        rm -rf deploy_temp
        
        # 提交并推送
        git add .
        git commit -m "Deploy: $(date '+%Y-%m-%d %H:%M:%S')"
        git push -f origin gh-pages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    # 可选：添加清理步骤
    - name: Cleanup
      if: always()
      run: |
        rm -rf deploy_temp || true